<html>
  <head>
    <meta charset="UTF-8">
    <title>OpenSpace Video Exporter</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script type="text/javascript" src="openspace-api.js"></script>
    <script type="text/javascript" src="main.js"></script>
  </head>
  <body>
    <div id="container" class="disconnected">
      <div id="connection-status" class="connection-status">Du m√•ste starta OpenSpace üîß</div>
    </div>
    <div class='header'>
      <h2 id="welcomeMessage">V√§lkommen till OpenSpace Video Exporter</h2>
    </div>
    <div id="isConnected">  
      <div class="card">
        <p style="display: inline; font-size:large;">Namn:</p> 
        <input type="text" id="username" onkeydown="return /[a-√∂\s]/i.test(event.key)">
      </div>
      <div class="card">
        <div id="flightdiv">
          <p id="latestFlight" class="inline">Det finns inga inspelade flygningar</p>
          <button class="folder" id="recordingsfolder" onClick="open_recordings_folder()"></button>
        </div>
        <button onClick="start_recording()" id="startrecording" class="animatedButton">Spela in ny flygtur</button>
        <button onClick="stop_recording()" id="stoprecording">Stoppa inspelning</button>
      </div>
      <div class="card">
        <button id="createVideo" onClick="create_video()">Skapa video</button>
      </div>
      <div class="card">
        <div>
          <h2>Information</h2>
        </div>
        <div id="logbox"></div>
      </div>    
    </div>
    <div class="card" id="isDisconnected">
      Starta OpenSpace och f√∂rs√∂ka igen :
      <button onClick="connectToOpenSpace()">Anslut</button>
    </div>
    <script type="text/javascript">
      // Checks that program is running on a supported OS
      // Shouldn't really be needed right now, but could be good if it's ever expanded to other platforms later
      if(window.navigator.platform === "Win32") {
        let ua = window.navigator.userAgent;
        let str = ua.substring(ua.indexOf("(")+1, ua.indexOf(")"));
        let parts = str.split(";");
        let plat;
        parts.forEach( e => { if(e.includes("NT")) { plat = Number(e.replace(/[^0-9\.]/gi, '')) } } );
        if(plat < 6.1) {
          // We don't support Windows older than Windows 7
          document.getElementById("welcomeMessage").innerHTML = "";
          document.getElementById("isDisconnected").innerHTML = "";
          document.getElementById("isDisconnected").classList.remove("card");
          document.getElementById("connection-status").innerHTML = "ERROR: Program only works on Windows 7 or newer"
        } 
        else {
          // Request notification permissions
          // NOTE: Support for Windows 7 requires specific build: https://tauri.app/v1/guides/building/windows#webview2-installation-options
          //       The required package for Win7 Notifications has already been included (see "windows7-compat" in cargo.toml)
          (async () => {
            _NOTIFICATION_PERMISSION_GRANTED_ = await isPermissionGranted();
            if (!_NOTIFICATION_PERMISSION_GRANTED_) {
              const permission = await requestPermission();
              _NOTIFICATION_PERMISSION_GRANTED_ = permission === 'granted';
            }
          })();

          // Loads file with animal names
          load_animals();

          // Connects to OpenSpace api
          connectToOpenSpace();
        }
      }
      else {
        document.getElementById("welcomeMessage").innerHTML = "";
        document.getElementById("isDisconnected").innerHTML = "";
        document.getElementById("isDisconnected").classList.remove("card");
        document.getElementById("connection-status").innerHTML = "ERROR: Program only works on Windows"
      }
    </script>
  </body>
</html>